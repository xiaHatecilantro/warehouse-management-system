<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.convenience.store.dao.ProductSupplierDao">
    <resultMap id="ProductSupplierResultMap" type="com.convenience.store.entity.ProductSupplier">
        <id property="productId" column="product_id" />
        <id property="supplierId" column="supplier_id" />
        <result property="supplyPrice" column="supply_price" />
        <result property="lastSupplyDate" column="last_supply_date" />
        <association property="product" javaType="com.convenience.store.entity.Product" resultMap="com.convenience.store.dao.ProductDao.ProductResultMap" />
        <association property="supplier" javaType="com.convenience.store.entity.Supplier" resultMap="com.convenience.store.dao.SupplierDao.SupplierResultMap" />
    </resultMap>

    <select id="getProductSuppliers" resultMap="ProductSupplierResultMap">
        SELECT ps.*, p.*, s.*
        FROM product_supplier ps
        JOIN products p ON ps.product_id = p.product_id
        JOIN suppliers s ON ps.supplier_id = s.supplier_id
    </select>

    <select id="getSuppliersByProductId" parameterType="int" resultMap="ProductSupplierResultMap">
        SELECT ps.*, p.*, s.*
        FROM product_supplier ps
        JOIN products p ON ps.product_id = p.product_id
        JOIN suppliers s ON ps.supplier_id = s.supplier_id
        WHERE ps.product_id = #{productId}
    </select>

    <select id="getProductsBySupplierId" parameterType="int" resultMap="ProductSupplierResultMap">
        SELECT ps.*, p.*, s.*
        FROM product_supplier ps
        JOIN products p ON ps.product_id = p.product_id
        JOIN suppliers s ON ps.supplier_id = s.supplier_id
        WHERE ps.supplier_id = #{supplierId}
    </select>

    <insert id="insertProductSupplier" parameterType="com.convenience.store.entity.ProductSupplier">
        INSERT INTO product_supplier (product_id, supplier_id, supply_price)
        VALUES (#{productId}, #{supplierId}, #{supplyPrice})
        ON DUPLICATE KEY UPDATE supply_price = #{supplyPrice}, last_supply_date = NOW()
    </insert>

    <delete id="deleteProductSupplier" parameterType="map">
        DELETE FROM product_supplier
        WHERE product_id = #{productId} AND supplier_id = #{supplierId}
    </delete>
</mapper>